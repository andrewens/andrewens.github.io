---
layout: post
title: "Quadtrees to optimize n-body gravity simulation"
tags: ["ship crew rpg", "technical", "favorite posts"]
thumbnail: https://drive.google.com/uc?id=1oS3hc3Sscgsc0WTOp4wx6sWxU-liUHvI&export=download
---

### About

While researching the optimized n-body gravity simulations for my [Ship Crew RPG]({% post_url 2023-6-29-ship-crew-rpg %}) game, I had to implement a quadtree / octree data structure so that I could implement the [Barnes-Hut algorithm](https://jheer.github.io/barnes-hut/).

> More about my Barnes-Hut gravity simulation [here.]({% post_url 2022-10-27-barnes-hut-algorithm %})

A quadtree (2 dimensional) or octree (3 dimensional) is a spatial partioning data structure that allows you to quickly retrieve a set of points that are in a given region of space.

In the context of the Barnes-Hut algorithm, a quadtree or octree allows us to easily approximate a set of far-away points as just one gravitational mass, which reduces time complexity from O(n^2) to O(n log n).

### Here's a demo ROBLOX place

> You can play/edit this demo on ROBLOX [here.](https://www.roblox.com/games/11326654961/Quadtree)

![polished-quad-tree-1.gif](https://drive.google.com/uc?id=1oS3hc3Sscgsc0WTOp4wx6sWxU-liUHvI&export=download)

_Each ball gets its own cell, generally speaking. Smaller cells are children of bigger cells._

![polished-quad-tree-2.gif](https://drive.google.com/uc?id=1m7lxf_LtdKK7QlzxMbB5XZ96AHEDZY1P&export=download)

_The purple crystal erases the board_

![polished-quad-tree-coincident-points.gif](https://drive.google.com/uc?id=1qzQyMY4pz4aDPHfNEj2N9_QLle42QN5z&export=download)

_Cell size has a minimum limit to avoid infinite recursion (and stack overflow) when coincident points are introduced._

### Unpolished quadtrees

This is an earlier version of the quadtree:

(The points are randomly added)

![slow-random-quad-tree-1.gif](https://drive.google.com/uc?id=1SBft1Ua-q9rJ31YMSNszjd0YgaKKgq0O&export=download)
![slow-random-quad-tree.gif](https://drive.google.com/uc?id=1g2rDD6OpXD2Tc_fukNrqqbMIT2bZ5uWy&export=download)

I experimented with implementing the quadtree as an array (similar to how one can implement a binary tree as an array). This gif visualizes where nodes are stored in the array:

![quad-tree-as-an-array.gif](https://drive.google.com/uc?id=16VGHTndYTQJ5uOYaIvPzrcHeyTrbBBLr&export=download)

And these are 3D Octrees, so-called because they have eight octants instead of four quadrants.

![random-oct-tree-1.gif](https://drive.google.com/uc?id=1IvPgBdtABHF2Rqet3Fsil7D6pnFcsPLN&export=download)

_Slow_

![random-oct-tree-2.gif](https://drive.google.com/uc?id=1FBlE47uFKVKpIg7mN3GvJVLhY-lkh_UW&export=download)

_Speedy_
